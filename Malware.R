#################################################################################################################
# HarvardX: PH125.9x - Capstone # 2 Project                                                                     #
# Malware Project                                                                                               #
# https://github.com/HugoAquinoNavarrete/Malware                                                                #
# R code                                                                                                        #
# Hugo Aquino                                                                                                   #
# Panama City                                                                                                   #
# February - 2022                                                                                               #
#################################################################################################################
# v1.0 - Initial version to download dataset from kaggle.com                                                    #
# v2.0 - Dataset analysis and variables filtrated based on correlation factor                                   #
# v3.0 - Datasets for train and test                                                                            #
# v4.0 - Algorithm # 1 - Binary Logistic Regression                                                             #
# v5.0 - Algorithm # 2 - Naive Bayes                                                                            #
# v6.0 - Algorithm # 3 - Decision Tree                                                                          #
# v7.0 - Algorithm # 4 - Random Forest                                                                          #
# v8.0 - Graphics                                                                                               #
# v9.0 - Time taken by algorithm to be executed                                                                 #
# v10.0 - Introduction, results and conclusion                                                                  #
#################################################################################################################

#################################################################################################################
# Libraries definition and usage                                                                                #
#################################################################################################################

# Install libraries with its dependencies 
if(!require(tidyverse)) install.packages(
  "tidyverse", repos = "http://cran.us.r-project.org",dependencies = TRUE)
if(!require(devtools)) install.packages(
  "devtools", repos = "http://cran.us.r-project.org",dependencies = TRUE)
if(!require(readr)) install.packages(
  "readr", repos = "http://cran.us.r-project.org",dependencies = TRUE)
if(!require(data.table)) install.packages(
  "data.table", repos = "http://cran.us.r-project.org",dependencies = TRUE)
if(!require(rvest)) install.packages(
  "rvest", repos = "http://cran.us.r-project.org",dependencies = TRUE)
if(!require(caret)) install.packages(
  "caret", repos = "http://cran.us.r-project.org",dependencies = TRUE)
if(!require(kableExtra)) install.packages(
  "kableExtra", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(corrr)) install.packages(
  "corrr", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(knitr)) install.packages(
  "knitr", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(e1071)) install.packages(
  "e1071", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(class)) install.packages(
  "class", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(tree)) install.packages(
  "tree", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(ISLR)) install.packages(
  "ISLR", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(randomForest)) install.packages(
  "randomForest", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(scales)) install.packages(
  "scales", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(ggplot2)) install.packages(
  "ggplot2", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(ggthemes)) install.packages(
  "ggthemes", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(rpart)) install.packages(
  "rpart", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(rpart.plot)) install.packages(
  "rpart.plot", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(gclus)) install.packages(
  "gclus", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(corrplot)) install.packages(
  "corrplot", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(ROCR)) install.packages(
  "ROCR", repos = "http://cran.us.r-project.org", dependencies = TRUE)
if(!require(tictoc)) install.packages(
  "tictoc", repos = "http://cran.us.r-project.org", dependencies = TRUE)

# Load libraries
library(tidyverse)
library(devtools)
library(readr)
library(data.table)
library(rvest)
library(caret)
library(kableExtra)
library(corrr)
library(knitr)
library(e1071)
library(class)
library(tree)
library(ISLR)
library(randomForest)
library(scales)
library(ggplot2)
library(ggthemes)
library(rpart)
library(rpart.plot)
library(gclus)
library(corrplot)
library(ROCR)
library(tictoc)

#################################################################################################################
# Multiplot function                                                                                            #
# Obtained from this URL                                                                                        #             
# https://stackoverflow.com/questions/24387376/r-error-could-not-find-function-multiplot-using-cookbook-example #
#################################################################################################################

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  require(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

#################################################################################################################
# Download, unzip and load dataset                                                                              #
# Note: this process could take a couple of minutes                                                             #
#################################################################################################################

# Download file
# During the day kaggle.com is with high load that maybe this 
# error would be generated in this section:
# In download.file(response[["url"]], "archive.zip", mode = "wb") :
# InternetOpenUrl failed: 'The operation timed out'
# Error in download.file(response[["url"]], "archive.zip", mode = "wb") 
# Try to execute at other moment of the day

if (file.exists("./data.csv") == TRUE){
  # Read file using "|" as delimiter and "." as decimal points
  data_loaded <- read.delim("data.csv", header = TRUE, sep = "|", dec = ".")

  # Class of dataset
  class(data_loaded)
  
} else {
#################################################################################################################
# R - Kaggler - API integration                                                                                 #
# The steps appear on this URL                                                                                  #             
# https://medium.com/mcd-unison/how-to-use-kaggle-api-to-download-datasets-in-r-312179c7a99c                    #
#################################################################################################################
  
  # Load Kaggler R API repository
  devtools::install_github("ldurazo/kaggler")
  
  # Load library
  library(kaggler)
  
  # Authenticate with the token generated
  # If you would like to do automatically, you will have 
  # to create your token con kaggle.com and put on the directory
  # where you want to run this file. 
  # For security reasons the token of the creator of this code
  # will not be uploaded to github.com
  kgl_auth(creds_file = 'kaggle.json')
  
  # Get the response from kaggle
  response <- kgl_datasets_download_all(
    owner_dataset = "divg07/malware-analysis-dataset")
  
  # Download file
  download.file(response[["url"]], "archive.zip", mode="wb")
  
  # Unzip file
  unzip_result <- unzip("archive.zip", overwrite = TRUE)
  }

# Amount of columns
ncol(data_loaded)

# Amount of rows
nrow(data_loaded)

# Display the first 10 records
head(data_loaded,10)

# Display the last 10 records
tail(data_loaded,10)

#################################################################################################################
# Lets do web scraping with a Microsoft web page related                                                        #
# https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#machine-types                                  #
#################################################################################################################

# This is URL of the site
url <- paste0("https://docs.microsoft.com/en-us/windows/win32/debug/pe-format")

# Read the page on HTML
page_loaded_html <- read_html(url)

# The class of this object
class(page_loaded_html)

# Convert HTML tables into data frames
tables <- page_loaded_html %>% html_nodes("table")

# Interested on table 3 - Machine Types
machines_types <- tables[[3]] %>% html_table
# Eliminate the first column named as "Constant"
machines_types <- subset( machines_types, select = -Constant)

# Interested on table 4 - Characteristics
characteristics <- tables[[4]] %>% html_table
characteristics <- subset( characteristics, select = -Flag)

# Interested on table 7 - Optional Header Standard Fields
optional_header_standard_fields <- tables[[7]] %>% html_table

# Interested on table 8 - PE32 Additional Field
pe32_additional_field <- tables[[8]] %>% html_table

# Interested on table 9 - Optional Header Windows Specific Fields
optional_header_windows_specific_fields <- tables[[9]] %>% html_table

# Interested on table 10 - Windows Subsystem
windows_subsystem_fields <- tables[[10]] %>% html_table
# Eliminate the first column named as "Constant"
windows_subsystem_fields <- subset(windows_subsystem_fields, select = -Constant)

# Interested on table 11 - DLL Characteristics Fields
dll_characteristics_fields <- tables[[11]] %>% html_table

#################################################################################################################
# The column "legitimate" indicate if the row is malware "0" or not "1"                                         #
# Change "legitimate" feature as factor                                                                         #
# Display how many rows exists of each one                                                                      #
# Create histograms to visualize entropy                                                                        #
#################################################################################################################

# Display amount of records that are malware or not
tribble(
  ~"Type", ~"# records",
  "Malware", data_loaded %>% filter(legitimate == 0) %>% nrow(),
  "No malware", data_loaded %>% filter(legitimate == 1) %>% nrow(),
) %>%
  kbl(
    ., 
    booktabs = T, 
    caption = "Amount of records on the dataset",
    format.args = list(big.mark = ","),
    digits = c(3, 4)) %>% 
  kable_styling(latex_options = "HOLD_position") %>%
  row_spec(0, bold = T)

entropy_malware <- data_loaded %>% 
  filter(legitimate == 0) %>% 
  summarise(mean(SectionsMaxEntropy))

entropy_not_malware <- data_loaded %>% 
  filter(legitimate == 1) %>% 
  summarise(mean(SectionsMaxEntropy))

data_loaded %>% 
  filter(legitimate == 0) %>% 
  ggplot(aes(x=SectionsMaxEntropy)) + 
  geom_histogram(bins=10, col="black", fill="red", alpha = .2) + 
  scale_y_continuous(labels=comma) +
  geom_vline(
    xintercept = entropy_malware$`mean(SectionsMaxEntropy)`, 
    col = "red", 
    linetype = "dashed") +
  annotate(
    "text",
    x = 6.4,
    y = 65000,
    label = "mean entropy: 7.38", 
    color = "red", size = 3) +
  labs(
    x="Entropy", 
    y="# Files", caption = "source data: data_loaded") +
  theme_hc() + ggtitle("Files with Malware") 
  
data_loaded %>% 
  filter(legitimate == 1) %>% 
  ggplot(aes(x=SectionsMaxEntropy)) + 
  geom_histogram(bins=10, col="blue", fill="green", alpha = .2) + 
  scale_y_continuous(labels=comma) +
  geom_vline(
    xintercept = entropy_not_malware$`mean(SectionsMaxEntropy)`, 
    col = "red", 
    linetype = "dashed") +
  annotate(
    "text",
    x = 5.1,
    y = 23000,
    label = "mean entropy: 5.96", 
    color = "red", size = 3) +
  labs(
    x="Entropy", 
    y="# Files", caption = "source data: data_loaded") +
  theme_hc() + ggtitle("Files without Malware") 

#################################################################################################################
# Create a dataset called "data_analysis_correlation"                                                           #
# excluding the "Name" and "md5" columns from "data_loaded" dataset                                             #
#################################################################################################################

data_analysis_correlation <- subset(data_loaded,select = -Name)
data_analysis_correlation <- subset(data_analysis_correlation,select = -md5)

#################################################################################################################
# Correlate the "data_analysis_correlation" dataset                                                             #
# focus on "legitimate" field,                                                                                  #
# display the correlation factor of each variable,                                                              #
# display how many and which are the variables with the correlation factor below and up to 0 and                #
#################################################################################################################

# Create a correlation matrix 
data_correlated <- correlate(data_analysis_correlation)

# Focus the correlation based on "legitimate" 
data_correlated_focused_legitimate <- data_correlated %>% focus(legitimate) %>% arrange(desc(legitimate))

# Display the correlation factors
data_correlated_focused_legitimate %>% kbl(., 
                     booktabs = T, 
                     longtable = T,
                     caption = "Correlations focused on \"legitimate\" field") %>% 
  kable_styling(latex_options = c("HOLD_position","repeat_header")) %>%
  row_spec(0, bold = T) %>% 
  column_spec(
    2, 
    color = "white",
    background = spec_color(
      data_correlated_focused_legitimate$legitimate, 
      direction= 1,
      end= max(data_correlated_focused_legitimate$legitimate)),
    popover = paste("legitimate:", data_correlated_focused_legitimate$legitimate))

# Display amount of variables and names based on a correlation factor 
tribble(
  ~"Correlation factor", ~"# variables", ~"Variables´ name",
  "Up 0", data_correlated_focused_legitimate %>% filter(legitimate > 0) %>% nrow(), data_correlated_focused_legitimate %>% filter(legitimate > 0) %>% .$term,
  "Below 0", data_correlated_focused_legitimate %>% filter(legitimate < 0) %>% nrow(), data_correlated_focused_legitimate %>% filter(legitimate < 0) %>% .$term,
  "Up 0.10", data_correlated_focused_legitimate %>% filter(legitimate > 0.10) %>% nrow(), data_correlated_focused_legitimate %>% filter(legitimate > 0.10) %>% .$term,) %>%
  kbl(
    ., 
    booktabs = T, 
    caption = "Amount of variables",
    format.args = list(big.mark = ","),
    digits = c(3, 4)) %>% 
  kable_styling(latex_options = "HOLD_position") %>%
  row_spec(0, bold = T)

#################################################################################################################
# Create a new dataset "data_filtrated" with the variable with correlation > 0.10                               #
#################################################################################################################

# Create a dataset to store the names of the variables that are up the correlation factor selected
variables_to_be_included <- data_correlated_focused_legitimate %>% 
  filter(legitimate > 0.10) %>% 
  .$term

# Add the "legitimate" variable
variables_to_be_included[length(variables_to_be_included) +1 ] <- "legitimate"

# Create another dataset with only the information related to the variables selected
data_filtrated <- subset(data_loaded, select = variables_to_be_included)

#################################################################################################################
# Visualize the sorted variables by correlation                                                                 #
#################################################################################################################

correlated_variables <- abs(cor(data_filtrated))
colors <- dmat.color(correlated_variables)
order <- order.single(correlated_variables)

# The generation of this graph 
# takes a couple of hours to complete !!
cpairs(data_filtrated, 
       order, 
       panel.colors = colors, 
       gap = 0.5,
       main = "Sorted and colored variables by correlation")

# Create a correlation plot
numeric_var <- names(data_filtrated)[which(sapply(data_filtrated, is.numeric))]

data_filtrated_cont <- data_filtrated[numeric_var]

correlations <- cor(na.omit(data_filtrated_cont[,]))

corrplot(correlations,
         method="square", 
         type='lower', 
         tl.offset=0.4,
         tl.cex=0.8,
         diag=FALSE)

#################################################################################################################
# Visualize information related to variables on "data_filtrated" dataset                                        #
#################################################################################################################

# For Machine
data_filtrated_Machine <- data_filtrated %>% 
  select(Machine,legitimate)
names(data_filtrated_Machine) <- c("Value","legitimate")
data_filtrated_Machine <- data_filtrated_Machine %>% 
  left_join(machines_types,by="Value")

data_filtrated_Machine %>%
  group_by(Description) %>%
  summarize(processors=n()) %>%
  arrange(desc(processors)) %>%
  ggplot(aes(x=reorder(Description, processors), y=processors)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 100000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= processors), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title="Kind of processor" , 
       caption = "source data: data_loaded_filtrated")

data_filtrated_Machine %>%
  filter(legitimate == 0) %>% 
  group_by(Description) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(Description, Count), y=Count)) +
  geom_bar(stat='identity', fill="red") +
  coord_flip(y=c(0, 100000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title="Kind of processor",
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

data_filtrated_Machine %>%
  filter(legitimate == 1) %>% 
  group_by(Description) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(Description, Count), y=Count)) +
  geom_bar(stat='identity', fill="green") +
  coord_flip(y=c(0, 30000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title="Kind of processor",
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

# For SizeOfOptionalHeader
data_filtrated_SizeOfOptionalHeader <- data_filtrated %>% 
  select(SizeOfOptionalHeader,legitimate)

data_filtrated_SizeOfOptionalHeader %>%
  group_by(SizeOfOptionalHeader) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(SizeOfOptionalHeader, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 125000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[2], 
       caption = "source data: data_loaded_filtrated")

SizeOfOptionalHeader_malware <- data_filtrated_SizeOfOptionalHeader %>%
  filter(legitimate == 0) %>% 
  group_by(SizeOfOptionalHeader) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(SizeOfOptionalHeader, Count), y=Count)) +
   geom_bar(stat='identity', fill="red") +
   coord_flip(y=c(0, 100000)) +
   labs(x= "", y="# files") + 
   geom_text(aes(label= Count), 
           position = position_stack(vjust= 0.5), 
           colour = "black", size = 4) +
   theme_hc() + 
  labs(title=variables_to_be_included[2],
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

SizeOfOptionalHeader_not_malware <- data_filtrated_SizeOfOptionalHeader %>%
  filter(legitimate == 1) %>% 
  group_by(SizeOfOptionalHeader) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(SizeOfOptionalHeader, Count), y=Count)) +
  geom_bar(stat='identity', fill="green") +
  coord_flip(y=c(0, 30000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[2],
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

multiplot(SizeOfOptionalHeader_not_malware,
          SizeOfOptionalHeader_malware,
          cols=2)

# For Subsystem
data_filtrated_Subsystem <- data_filtrated %>% 
  select(Subsystem,legitimate)

data_filtrated_Subsystem %>%
  group_by(Subsystem) %>%
  summarize(subsystems=n()) %>%
  arrange(desc(subsystems)) %>%
  ggplot(aes(x=reorder(Subsystem, subsystems), y=subsystems)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 125000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= subsystems), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[3], 
       caption = "source data: data_loaded_filtrated")

Subsystem_malware <- data_filtrated_Subsystem %>%
  filter(legitimate == 0) %>% 
  group_by(Subsystem) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(Subsystem, Count), y=Count)) +
  geom_bar(stat='identity', fill="red") +
  coord_flip(y=c(0, 100000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[3],
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

Subsystem_not_malware <- data_filtrated_Subsystem %>%
  filter(legitimate == 1) %>% 
  group_by(Subsystem) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(Subsystem, Count), y=Count)) +
  geom_bar(stat='identity', fill="green") +
  coord_flip(y=c(0, 25000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[3],
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

multiplot(Subsystem_not_malware,
          Subsystem_malware,
          cols=2)

# For MajorSubsystemVersion
data_filtrated_MajorSubsystemVersion <- data_filtrated %>% 
  select(MajorSubsystemVersion,legitimate)

data_filtrated_MajorSubsystemVersion %>%
  group_by(MajorSubsystemVersion) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(MajorSubsystemVersion, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 80000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[4], 
       caption = "source data: data_loaded_filtrated")

MajorSubsystemVersion_malware <- data_filtrated_MajorSubsystemVersion %>%
  filter(legitimate == 0) %>% 
  group_by(MajorSubsystemVersion) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(MajorSubsystemVersion, Count), y=Count)) +
  geom_bar(stat='identity', fill="red") +
  coord_flip(y=c(0, 70000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[4],
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

MajorSubsystemVersion_not_malware <- data_filtrated_MajorSubsystemVersion %>%
  filter(legitimate == 1) %>% 
  group_by(MajorSubsystemVersion) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  ggplot(aes(x=reorder(MajorSubsystemVersion, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 20000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[4],
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

multiplot(MajorSubsystemVersion_not_malware,
          MajorSubsystemVersion_malware,
          cols=2)

# For VersionInformationSize
data_filtrated_VersionInformationSize <- data_filtrated %>% 
  select(VersionInformationSize,legitimate)

data_filtrated_VersionInformationSize %>%
  group_by(VersionInformationSize) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(VersionInformationSize, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 40000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[5], 
       caption = "source data: data_loaded_filtrated")

VersionInformationSize_malware <- data_filtrated_VersionInformationSize %>%
  filter(legitimate == 0) %>% 
  group_by(VersionInformationSize) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(VersionInformationSize, Count), y=Count)) +
  geom_bar(stat='identity', fill="red") +
  coord_flip(y=c(0, 40000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[5],
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

VersionInformationSize_not_malware <- data_filtrated_VersionInformationSize %>%
  filter(legitimate == 1) %>% 
  group_by(VersionInformationSize) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(VersionInformationSize, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 30000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[5],
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

multiplot(VersionInformationSize_not_malware,
          VersionInformationSize_malware,
          cols=2)

# For ResourcesMinEntropy
data_filtrated_ResourcesMinEntropy <- data_filtrated %>% 
  select(ResourcesMinEntropy,legitimate)

ResourcesMinEntropy_malware <- data_filtrated_ResourcesMinEntropy %>% 
  filter(legitimate == 0) %>% 
  ggplot(aes(x=ResourcesMinEntropy)) + 
  geom_histogram(bins=8, col="black", fill="red", alpha = .2) + 
  scale_y_continuous(labels=comma) +
  labs(
    x=variables_to_be_included[6], 
    y="# Files", caption = "source data: data_loaded_filtrated") +
  theme_hc() + ggtitle("Files with Malware") 

ResourcesMinEntropy_not_malware <- data_filtrated_ResourcesMinEntropy %>% 
  filter(legitimate == 1) %>% 
  ggplot(aes(x=ResourcesMinEntropy)) + 
  geom_histogram(bins=6, col="blue", fill="green", alpha = .2) + 
  scale_y_continuous(labels=comma) +
  labs(
    x=variables_to_be_included[6], 
    y="# Files", caption = "source data: data_loaded_filtrated") +
  theme_hc() + ggtitle("Files without Malware") 

multiplot(ResourcesMinEntropy_not_malware,
          ResourcesMinEntropy_malware,
          cols=2)

# For Characteristics
data_filtrated_Characteristics <- data_filtrated %>% 
  select(Characteristics,legitimate)

data_filtrated_Characteristics %>%
  group_by(Characteristics) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(Characteristics, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 70000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[7], 
       caption = "source data: data_loaded_filtrated")

Characteristics_malware <- data_filtrated_Characteristics %>%
  filter(legitimate == 0) %>% 
  group_by(Characteristics) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(Characteristics, Count), y=Count)) +
  geom_bar(stat='identity', fill="red") +
  coord_flip(y=c(0, 68000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[7],
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

Characteristics_not_malware <- data_filtrated_Characteristics %>%
  filter(legitimate == 1) %>% 
  group_by(Characteristics) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(Characteristics, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 16000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[7],
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

multiplot(Characteristics_not_malware,
          Characteristics_malware,
          cols=2)

# For ExportNb
data_filtrated_ExportNb <- data_filtrated %>% 
  select(ExportNb,legitimate)

data_filtrated_ExportNb %>%
  group_by(ExportNb) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(ExportNb, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 110000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[9], 
       caption = "source data: data_loaded_filtrated")

ExportNb_malware <- data_filtrated_ExportNb %>%
  filter(legitimate == 0) %>% 
  group_by(ExportNb) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(ExportNb, Count), y=Count)) +
  geom_bar(stat='identity', fill="red") +
  coord_flip(y=c(0, 100000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[9],
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

ExportNb_not_malware <- data_filtrated_ExportNb %>%
  filter(legitimate == 1) %>% 
  group_by(ExportNb) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(ExportNb, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 15000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[9],
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

multiplot(ExportNb_not_malware,
          ExportNb_malware,
          cols=2)

# For ImportsNbOrdinal
data_filtrated_ImportsNbOrdinal <- data_filtrated %>% 
  select(ImportsNbOrdinal,legitimate)

data_filtrated_ImportsNbOrdinal %>%
  group_by(ImportsNbOrdinal) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(ImportsNbOrdinal, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 100000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title="ImportsNbOrdinal" , 
       caption = "source data: data_loaded_filtrated")

ImportsNbOrdinal_malware <- data_filtrated_ImportsNbOrdinal %>%
  filter(legitimate == 0) %>% 
  group_by(ImportsNbOrdinal) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(ImportsNbOrdinal, Count), y=Count)) +
  geom_bar(stat='identity', fill="red") +
  coord_flip(y=c(0, 70000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[9],
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

ImportsNbOrdinal_not_malware <- data_filtrated_ImportsNbOrdinal %>%
  filter(legitimate == 1) %>% 
  group_by(ImportsNbOrdinal) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(ImportsNbOrdinal, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 30000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[9],
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

multiplot(ImportsNbOrdinal_not_malware,
          ImportsNbOrdinal_malware,
          cols=2)

# For FileAlignment
data_filtrated_FileAlignment <- data_filtrated %>% 
  select(FileAlignment,legitimate)

data_filtrated_FileAlignment %>%
  group_by(FileAlignment) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(FileAlignment, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 150000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[10], 
       caption = "source data: data_loaded_filtrated")

FileAlignment_malware <- data_filtrated_FileAlignment %>%
  filter(legitimate == 0) %>% 
  group_by(FileAlignment) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(FileAlignment, Count), y=Count)) +
  geom_bar(stat='identity', fill="red") +
  coord_flip(y=c(0, 100000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[10],
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

FileAlignment_not_malware <- data_filtrated_FileAlignment %>%
  filter(legitimate == 1) %>% 
  group_by(FileAlignment) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(FileAlignment, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 40000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[10],
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

multiplot(FileAlignment_not_malware,
          FileAlignment_malware,
          cols=2)

# For ImportsNb
data_filtrated_ImportsNb <- data_filtrated %>% 
  select(ImportsNb,legitimate)

data_filtrated_ImportsNb %>%
  group_by(ImportsNb) %>%
  summarize(Count=n()) %>%
  arrange(desc(Count)) %>%
  head(8) %>%
  ggplot(aes(x=reorder(ImportsNb, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 15000)) +
  labs(x= "", y="# files") +
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[11], 
       caption = "source data: data_loaded_filtrated")

ImportsNb_malware <- data_filtrated_ImportsNb %>%
  filter(legitimate == 0) %>% 
  group_by(ImportsNb) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(ImportsNb, Count), y=Count)) +
  geom_bar(stat='identity', fill="red") +
  coord_flip(y=c(0, 15000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[11],
       subtitle="Files with Malware",
       caption = "source data: data_loaded_filtrated")

ImportsNb_not_malware <- data_filtrated_ImportsNb %>%
  filter(legitimate == 1) %>% 
  group_by(ImportsNb) %>% 
  summarize(Count=n()) %>% 
  arrange(desc(Count)) %>%
  head(6) %>%
  ggplot(aes(x=reorder(ImportsNb, Count), y=Count)) +
  geom_bar(stat='identity', fill="blue") +
  coord_flip(y=c(0, 10000)) +
  labs(x= "", y="# files") + 
  geom_text(aes(label= Count), 
            position = position_stack(vjust= 0.5), 
            colour = "black", size = 4) +
  theme_hc() + 
  labs(title=variables_to_be_included[11],
       subtitle="Files without Malware",
       caption = "source data: data_loaded_filtrated")

multiplot(ImportsNb_not_malware,
          ImportsNb_malware,
          cols=2)

#################################################################################################################
# Splitting the dataset "data_filtrated" into the train and test set                                            #
#################################################################################################################

# Use seed to replicate results
set.seed(2022, sample.kind="Rounding") # if using R 3.5 or earlier, use `set.seed(2022)`

# Validation set will be 10% of data_filtrated data
test_index <- createDataPartition(
  y = data_filtrated$legitimate, 
  times = 1, 
  p = 0.1, 
  list = FALSE)

# Create the datasets
test_set <- data_filtrated[test_index,]
train_set <- data_filtrated[-test_index,]

#################################################################################################################
# Algorithms to be tested for this classification use case                                                      #
# Apply scale feature scaling to train and test datasets                                                        #
# Change "legitimate" to be a "factor"                                                                          #
#################################################################################################################

# Store in a dataset the value of "legitimate" variable for test and train datasets
test_set_legitimate <- test_set$legitimate
train_set_legitimate <- train_set$legitimate

# Create two additional datasets as a copy of test and train that will be used on decision tree
test_set_tree <- test_set
train_set_tree <- train_set

# Change "legitimate" variable to be a factor in the datasets that will be used on decision tree
test_set_tree$legitimate <- factor(
  test_set_tree$legitimate, 
  levels = c(0, 1))
train_set_tree$legitimate <- factor(
  train_set_tree$legitimate, 
  levels = c(0, 1))

# Apply scale featuring to the test and train datasets due to the different values in each variable
test_set <- scale(test_set[1:ncol(test_set)])
train_set <- scale(train_set[1:ncol(train_set)])

# Change the test and train datasets to be a data frame
test_set <- as.data.frame(test_set)
train_set <- as.data.frame(train_set)

# Restore the "legitimate" value on the test and train datasets
test_set$legitimate <- test_set_legitimate
train_set$legitimate <- train_set_legitimate

# Change "legitimate" variable to be a factor in the datasets that stored the "legitimate" value
train_set_legitimate <- factor(train_set_legitimate, levels = c(0, 1))
test_set_legitimate <- factor(test_set_legitimate, levels = c(0, 1))

# Change "legitimate" variable to be a factor in the test and train datasets
test_set$legitimate <- factor(test_set$legitimate, levels = c(0, 1))
train_set$legitimate <- factor(train_set$legitimate, levels = c(0, 1))

#################################################################################################################
# First algorithm - Binary Logistic Regression                                                                  #
#################################################################################################################

# Begin to obtain the time duration of the algorithm
tic("Total",quiet = FALSE)
tic("Apply algorithm",quiet = FALSE)

# Apply the algorithm
binary_logistic_regression_algorithm <- train_set %>% glm(
  legitimate ~ ., 
  family=binomial, 
  data=.)
toc(quiet = FALSE)

tic("Predict with the model",quiet = FALSE)
# Predict based on the algorithm
binary_logistic_regression_pred <- predict(
  binary_logistic_regression_algorithm, 
  newdata = test_set, 
  type = "response")
toc(quiet = FALSE)

# Calculate the time invested to run the algorithm
time_binary_logistic_regression_algorithm <- toc(quiet = TRUE)
time_binary_logistic_regression_algorithm <- time_binary_logistic_regression_algorithm$toc - time_binary_logistic_regression_algorithm$tic

# Create factors based on predictions
y_hat_binary_logistic_regression <- ifelse(
  binary_logistic_regression_pred > 0.5, "1", "0") %>% 
  factor

# Elaborate the confusion matrix
binary_logistic_regression_confusion_matrix <- confusionMatrix(
  y_hat_binary_logistic_regression, 
  test_set$legitimate)

# Print the confusion matrix
binary_logistic_regression_confusion_matrix$table

# Performance
prediction_binary_logistic_regression <- prediction(
  binary_logistic_regression_pred, 
  test_set$legitimate)
performance_binary_logistic_regression <- performance(
  prediction_binary_logistic_regression, 
  "acc")

# Calculate AUC
auc_binary_logistic_regression <- performance(
  prediction_binary_logistic_regression, 
  measure = "auc")

# Store the results on a dataframe
results <- data_frame(
  Algorithm = "#1 - Binary Logistic Regression",
  TP = binary_logistic_regression_confusion_matrix$table[1,1],
  TN = binary_logistic_regression_confusion_matrix$table[2,2],
  FP = binary_logistic_regression_confusion_matrix$table[2,1],
  FN = binary_logistic_regression_confusion_matrix$table[1,2],
  Accuracy = binary_logistic_regression_confusion_matrix$overall["Accuracy"],
  Sensitivity = binary_logistic_regression_confusion_matrix$byClass["Sensitivity"],
  FPR = 1 - binary_logistic_regression_confusion_matrix$byClass["Specificity"],
  Specificity = binary_logistic_regression_confusion_matrix$byClass["Specificity"],
  AUC = as.numeric(auc_binary_logistic_regression@y.values),
  Time = time_binary_logistic_regression_algorithm
)

# Create a ROC curve
plot.new()
roc_binary_logistic_regression <- performance(
  prediction_binary_logistic_regression,
  "tpr",
  "fpr")
plot(roc_binary_logistic_regression, colorize = T, lwd = 2)
abline(a = 0, b = 1) 
title(main = "ROC - Binary Logistic Regression")

#################################################################################################################
# Second algorithm - Naive Bayes                                                                                #
#################################################################################################################

# Obtain the time duration of the algorithm
tic("Total",quiet = FALSE)
tic("Apply algorithm",quiet = FALSE)

# Apply the algorithm
naiveBayes_algorithm <- naiveBayes(
  x = train_set[1:ncol(train_set)-1], 
  y = train_set$legitimate)
toc(quiet = FALSE)

tic("Predict with the model",quiet = FALSE)
# Predict based on the algorithm
y_hat_naiveBayes <- predict(
  naiveBayes_algorithm, 
  newdata = test_set)
toc(quiet = FALSE)

# Calculate the time invested to run the algorithm
time_naiveBayes <- toc(quiet = FALSE)
time_naiveBayes <- time_naiveBayes$toc - time_naiveBayes$tic

# Elaborate the confusion matrix
naiveBayes_confusion_matrix <- confusionMatrix(
  data=y_hat_naiveBayes, 
  reference = test_set$legitimate)

# Print the confusion matrix
naiveBayes_confusion_matrix$table

# Performance
prediction_naiveBayes <- prediction(
  as.numeric(y_hat_naiveBayes)-1, 
  test_set$legitimate)
performance_naiveBayes <- performance(
  prediction_naiveBayes, 
  "acc")

# Calculate AUC
auc_naiveBayes <- performance(
  prediction_naiveBayes, 
  measure = "auc")

# Append the results to the dataframe
results <- bind_rows(
  results,
  data_frame(
    Algorithm = "#2 - Naive Bayes",
    TP = naiveBayes_confusion_matrix$table[1,1],
    TN = naiveBayes_confusion_matrix$table[2,2],
    FP = naiveBayes_confusion_matrix$table[2,1],
    FN = naiveBayes_confusion_matrix$table[1,2],
    Accuracy = naiveBayes_confusion_matrix$overall["Accuracy"],
    Sensitivity = naiveBayes_confusion_matrix$byClass["Sensitivity"],
    FPR = 1 - naiveBayes_confusion_matrix$byClass["Specificity"],
    Specificity = naiveBayes_confusion_matrix$byClass["Specificity"],
    AUC = as.numeric(auc_naiveBayes@y.values),
    Time = time_naiveBayes)
)

# Create a ROC curve
plot.new()
roc_naiveBayes <- performance(
  prediction_naiveBayes,
  "tpr",
  "fpr")
plot(roc_naiveBayes, colorize = T, lwd = 2)
abline(a = 0, b = 1) 
title(main = "ROC - naiveBayes")

#################################################################################################################
# Third algorithm - Decision tree                                                                               #
#################################################################################################################

# Begin to obtain the time duration of the algorithm
tic("Total",quiet = FALSE)
tic("Apply algorithm",quiet = FALSE)

# Apply the algorithm
tree_algorithm <- rpart(
  train_set_tree$legitimate ~ ., 
  data = train_set_tree[1:ncol(train_set_tree)-1])
toc(quiet = FALSE)

tic("Predict with the model",quiet = FALSE)
# Predict based on the algorithm
y_hat_tree <- predict(
  tree_algorithm, 
  test_set_tree, 
  type="class")
toc(quiet = FALSE)

# Calculate the time invested to run the algorithm
time_tree <- toc(quiet = FALSE)
time_tree <- time_tree$toc - time_tree$tic

# Plot the tree created
rpart.plot(tree_algorithm,
           type=3,
           under=TRUE,
           cex=0.7,
           under.cex=1.1,
           extra=100,
           box.palette = c("pink", "green"))

# Elaborate the confusion matrix
tree_confusion_matrix <- confusionMatrix(
  data=y_hat_tree, 
  reference = test_set_tree$legitimate)

# Print the confusion matrix
tree_confusion_matrix$table

# Performance
prediction_tree <- prediction(
  as.numeric(y_hat_tree)-1, 
  test_set$legitimate)
performance_tree <- performance(
  prediction_tree, 
  "acc")

# Calculate AUC
auc_tree <- performance(
  prediction_tree, 
  measure = "auc")

# Append the results to the dataframe
results <- bind_rows(
  results,
  data_frame(
    Algorithm = "#3 - Decision Tree",
    TP = tree_confusion_matrix$table[1,1],
    TN = tree_confusion_matrix$table[2,2],
    FP = tree_confusion_matrix$table[2,1],
    FN = tree_confusion_matrix$table[1,2],
    Accuracy = tree_confusion_matrix$overall["Accuracy"],
    Sensitivity = tree_confusion_matrix$byClass["Sensitivity"],
    FPR = 1 - tree_confusion_matrix$byClass["Specificity"],
    Specificity = tree_confusion_matrix$byClass["Specificity"],
    AUC = as.numeric(auc_tree@y.values),
    Time = time_tree)
)

# Create a ROC curve
plot.new()
roc_tree <- performance(
  prediction_tree,
  "tpr",
  "fpr")
plot(roc_tree, colorize = T, lwd = 2)
abline(a = 0, b = 1) 
title(main = "ROC - Decision Tree")

#################################################################################################################
# Fourth algorithm - Random Forrest                                                                             #
#################################################################################################################

# Begin to obtain the time duration of the algorithm
tic("Total",quiet = FALSE)
tic("Apply algorithm",quiet = FALSE)

# Apply the algorithm
random_forest_algorithm <- randomForest(
  train_set$legitimate ~ .,
  data = train_set[1:ncol(train_set)-1])
toc(quiet = FALSE)

tic("Predict with the model",quiet = FALSE)
# Predict based on the algorithm
y_hat_random_forest <- predict(
  random_forest_algorithm, 
  newdata = test_set)
toc(quiet = FALSE)

# Calculate the time invested to run the algorithm
time_random_forest <- toc()
time_random_forest <- time_random_forest$toc - time_random_forest$tic

# Elaborate the confusion matrix
random_forest_confusion_matrix <- confusionMatrix(
  data=y_hat_random_forest, 
  reference = test_set$legitimate)

# Performance
prediction_random_forest <- prediction(
  as.numeric(y_hat_random_forest)-1, 
  test_set$legitimate)

performance_random_forest <- performance(
  prediction_random_forest, 
  "acc")

# Calculate AUC
auc_random_forest <- performance(
  prediction_random_forest, 
  measure = "auc")

# Append the results to the dataframe
results <- bind_rows(
  results,
  data_frame(
    Algorithm = "#4 - Random Forest",
    TP = random_forest_confusion_matrix$table[1,1],
    TN = random_forest_confusion_matrix$table[2,2],
    FP = random_forest_confusion_matrix$table[2,1],
    FN = random_forest_confusion_matrix$table[1,2],
    Accuracy = random_forest_confusion_matrix$overall["Accuracy"],
    Sensitivity = random_forest_confusion_matrix$byClass["Sensitivity"],
    FPR = 1 - random_forest_confusion_matrix$byClass["Specificity"],
    Specificity = random_forest_confusion_matrix$byClass["Specificity"],
    AUC = as.numeric(auc_random_forest@y.values),
    Time = time_random_forest)
)

# Create a ROC curve
plot.new()
roc_random_forest <- performance(
  prediction_random_forest,
  "tpr",
  "fpr")
plot(roc_random_forest, colorize = T, lwd = 2)
abline(a = 0, b = 1) 
title(main = "ROC - Random Forest")

#################################################################################################################
# Fifth algorithm - Knn                                                                                         #
#################################################################################################################

knn_algorithm <- gknn(
  train_set_legitimate ~ ., 
  data = train_set[1:ncol(train_set)-1], 
  k = 3, 
  method = "Manhattan")

#knn_algorithm <- gknn(
#  train_set_legitimate ~ ., 
#  data = train_set[1:ncol(train_set)-1], 
#  k=round(sqrt(nrow(train_set))))

y_hat_knn <- predict(knn_algorithm, test_set)

# An error message is generated
# Error: cannot allocate vector of size 12.8 Gb
# This algorithms were run on a laptop with this specifications
# 8 GiB RAM
# 2 virtual cores
# 2.90 GHz Intel processor speed
# Windows 10

# Elaborate the confusion matrix
#knn_confusion_matrix <- confusionMatrix(data=y_hat_knn, reference = test_set$legitimate)

#################################################################################################################
# Print the dataframe content with the models results                                                           #
#################################################################################################################
options(digits = 4) 

results %>% kbl(.,
                booktabs = T, 
                caption = "Results obtained") %>% 
  kable_styling(latex_options = "HOLD_position") %>%
  row_spec(0, bold = T) %>% 
  column_spec(
    2, 
    color = "red",
    background = spec_color(
      results$TP, 
      direction= 1,
      end=1.0),
    popover = paste("TP", results$TP)) %>% 
  column_spec(
    3, 
    color = "red",
    background = spec_color(
      results$TN, 
      direction= 1,
      end=1.0),
    popover = paste("TN:", results$TN)) %>% 
  column_spec(
    4, 
    color = "red",
    background = spec_color(
      results$FP, 
      direction= -1,
      end=1.0),
    popover = paste("FP:", results$FP)) %>% 
  column_spec(
    5, 
    color = "red",
    background = spec_color(
      results$FN, 
      direction= -1,
      end=1.0),
    popover = paste("FN:", results$FN)) %>%
  column_spec(
    6, 
    color = "red",
    background = spec_color(
      results$Accuracy, 
      direction= 1,
      end=1.0),
    popover = paste("Accuracy:", results$Accuracy)) %>% 
  column_spec(
    7, 
    color = "red",
    background = spec_color(
      results$Sensitivity, 
      direction= 1,
      end=1.0),
    popover = paste("Sensitivity:", results$Sensitivity)) %>% 
  column_spec(
    8, 
    color = "red",
    background = spec_color(
      results$FPR, 
      direction= -1,
      end=1.0),
    popover = paste("FPR:", results$FPR)) %>% 
  column_spec(
    9, 
    color = "red",
    background = spec_color(
      results$Specificity, 
      direction= 1,
      end=1.0),
    popover = paste("Specificity:", results$Specificity)) %>%
  column_spec(
    10, 
    color = "red",
    background = spec_color(
      results$AUC, 
      direction= 1,
      end=1.0),
    popover = paste("AUC:", results$AUC)) %>%
  column_spec(
    11, 
    color = "red",
    background = spec_color(
      results$Time, 
      direction= -1,
      end=1.0),
    popover = paste("Time:", results$Time))
  
#################################################################################################################
# Generate ROC curves for the algorithms´ performance                                                           #
#################################################################################################################

plot.new()
par(mfcol=c(1,4))

plot(roc_binary_logistic_regression, colorize = T, lwd = 2)
abline(a = 0, b = 1) 
title(main = "ROC - Logistic Regression")

plot(roc_naiveBayes, colorize = T, lwd = 2)
abline(a = 0, b = 1) 
title(main = "ROC - naiveBayes")

plot(roc_tree, colorize = T, lwd = 2)
abline(a = 0, b = 1) 
title(main = "ROC - Decision Tree")

plot(roc_random_forest, colorize = T, lwd = 2)
abline(a = 0, b = 1) 
title(main = "ROC - Random Forest")

#################################################################################################################
# End of R Capstone script                                                                                      #
#################################################################################################################
